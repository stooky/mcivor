---
interface Props {
  showSubject?: boolean;
}

const {
  showSubject = true,
} = Astro.props;

// Determine API endpoint based on environment
const isDev = import.meta.env.DEV;
const apiEndpoint = isDev ? 'http://localhost:3001/contact' : '/api/contact.php';
---

<form id="contact-form" class="space-y-6" data-endpoint={apiEndpoint}>
  <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
    <div>
      <label for="firstName" class="block text-sm font-medium text-gray-700">
        First Name
      </label>
      <input
        type="text"
        name="firstName"
        id="firstName"
        required
        class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 shadow-sm focus:border-primary-500 focus:ring-primary-500"
      />
    </div>
    <div>
      <label for="lastName" class="block text-sm font-medium text-gray-700">
        Last Name
      </label>
      <input
        type="text"
        name="lastName"
        id="lastName"
        required
        class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 shadow-sm focus:border-primary-500 focus:ring-primary-500"
      />
    </div>
  </div>

  <div>
    <label for="email" class="block text-sm font-medium text-gray-700">
      Email
    </label>
    <input
      type="email"
      name="email"
      id="email"
      required
      class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 shadow-sm focus:border-primary-500 focus:ring-primary-500"
    />
  </div>

  <div>
    <label for="phone" class="block text-sm font-medium text-gray-700">
      Phone <span class="text-gray-400">(optional)</span>
    </label>
    <input
      type="tel"
      name="phone"
      id="phone"
      class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 shadow-sm focus:border-primary-500 focus:ring-primary-500"
    />
  </div>

  {showSubject && (
    <div>
      <label for="subject" class="block text-sm font-medium text-gray-700">
        Subject
      </label>
      <select
        name="subject"
        id="subject"
        class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 shadow-sm focus:border-primary-500 focus:ring-primary-500"
      >
        <option value="">Select a subject</option>
        <option value="general">General Inquiry</option>
        <option value="services">Services</option>
        <option value="quote">Request a Quote</option>
        <option value="support">Support</option>
        <option value="other">Other</option>
      </select>
    </div>
  )}

  <div>
    <label for="message" class="block text-sm font-medium text-gray-700">
      Message
    </label>
    <textarea
      name="message"
      id="message"
      rows="5"
      required
      class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 shadow-sm focus:border-primary-500 focus:ring-primary-500"
    ></textarea>
  </div>

  <!-- Honeypot field for spam prevention (hidden from users) -->
  <div class="hidden" aria-hidden="true">
    <label for="website_url">Website</label>
    <input type="text" name="website_url" id="website_url" tabindex="-1" autocomplete="off" />
  </div>

  <!-- Status message -->
  <div id="form-status" class="hidden rounded-lg p-4"></div>

  <div>
    <button
      type="submit"
      id="submit-btn"
      class="w-full rounded-lg bg-primary-600 px-6 py-3 text-base font-medium text-white shadow-sm transition-colors hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span id="btn-text">Send Message</span>
      <span id="btn-loading" class="hidden">
        <svg class="animate-spin inline-block h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Sending...
      </span>
    </button>
  </div>
</form>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const status = document.getElementById('form-status') as HTMLDivElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const btnText = document.getElementById('btn-text') as HTMLSpanElement;
    const btnLoading = document.getElementById('btn-loading') as HTMLSpanElement;

    if (!form) return;

    const endpoint = form.dataset.endpoint || '/api/contact.php';

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Get form data
      const formData = new FormData(form);
      const data: Record<string, string> = {};
      formData.forEach((value, key) => {
        data[key] = value.toString();
      });

      // Show loading state
      submitBtn.disabled = true;
      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');
      status.classList.add('hidden');

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          // Success
          status.className = 'rounded-lg p-4 bg-green-50 text-green-800 border border-green-200';
          status.innerHTML = `
            <div class="flex items-center">
              <svg class="h-5 w-5 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              ${result.message}
            </div>
          `;
          form.reset();
        } else {
          // Error from server
          status.className = 'rounded-lg p-4 bg-red-50 text-red-800 border border-red-200';
          status.innerHTML = `
            <div class="flex items-center">
              <svg class="h-5 w-5 mr-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
              ${result.message}
            </div>
          `;
        }
      } catch (error) {
        // Network error
        status.className = 'rounded-lg p-4 bg-red-50 text-red-800 border border-red-200';
        status.innerHTML = `
          <div class="flex items-center">
            <svg class="h-5 w-5 mr-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Unable to send message. Please try again or contact us directly.
          </div>
        `;
        console.error('Form submission error:', error);
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
        status.classList.remove('hidden');

        // Scroll to status message
        status.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    });
  });
</script>
